@model InputDetail

@using Malsys.Processing;
@using Malsys.Web.Models.Lsystem;


<div class="right">permalink: @Html.InputPermaLink(Model.Input.UrlId)</div>
<h2>@Model.Input.PublishName</h2>
<div class="right">@if (Model.CurrentUserIsOwner) { @Html.ActionLink("Edit or change publish settings", MVC.Gallery.Edit(Model.Input.UrlId)) }</div>
<h4>by @Html.ActionLink(Model.Input.User.Name, MVC.Gallery.Index(Model.Input.User.Name)) @if (Model.CurrentUserIsOwner) { <text>(you)</text> }</h4>

@{
	ViewBag.Title = Model.Input.PublishName;

	var fi = new FileInfo(Model.FilePath);
	if (!fi.Exists) {
		<p>File no found!</p>
		return;
	}

	if (!Model.Input.IsPublished) {
		<p>Not published</p>
	}

}

@switch (Model.Input.MimeType) {

	case MimeType.Text.Plain:
		using (var sr = fi.OpenText()) {
			bool asciiArt = OutputMetadataHelper.TryGetValue(Model.Metadata, OutputMetadataKeyHelper.OutputIsAsciiArt, false);
			<pre class="box @(asciiArt ? "asciiArt" : "")">@sr.ReadToEnd()</pre>
		}
		break;

	case MimeType.Image.SvgXml:
		int width = OutputMetadataHelper.TryGetValue(Model.Metadata, OutputMetadataKeyHelper.OutputWidth, -1);
		int height = OutputMetadataHelper.TryGetValue(Model.Metadata, OutputMetadataKeyHelper.OutputHeight, -1);
		bool hasValidSize = width > 0 && height > 0;
		<div class="scrollBox">
			<img src="@Url.Action(MVC.Gallery.GetOutput(Model.Input.UrlId))" @if (hasValidSize) { <text>width="@(width)px" height="@(height)px"</text> } alt="Process result" />
		</div>
		break;

	case MimeType.Application.Json:
		<div class="threeJsScene" data-scene="@Url.Action(MVC.Gallery.GetOutput(Model.Input.UrlId))" data-clear-color="FFFFFF" data-anti-alias="true">
			<p class="webgl">WebGL is not supported by your browser. Please @Html.Link("get supported browser", "http://get.webgl.org/", "get supported browser"). @Html.ActionLink("Why?", MVC.Home.WhyWebgl())</p>
			<p class="controls">Controls: Move mouse &amp; press LEFT/A: rotate, MIDDLE/S: zoom, RIGHT/D: pan</p>
			<a href="@Url.Action(MVC.Gallery.FullScreen(Model.Input.UrlId))" class="fullscreen">Full screen</a>
		</div>
		<p>
			Note that L-systems is actual 3D scene rendered by your browser and you can rotate, zoom or pan with it.
		</p>
		<text>
		@section scripts {
			@Content.Js(Links.Js.ThreeJs.Three_js)
			@Content.Js(Links.Js.ThreeJs.Detector_js)
			@Content.Js(Links.Js.ThreeJs.Stats_js)
			@Content.Js(Links.Js.ThreeJs.malsys_three_js)
		}
		</text>
break;

	default:
		<p class="outputTruncated">Unknown output type `@Model.Input.MimeType`.</p>
											 break;
}

@if (!string.IsNullOrWhiteSpace(Model.Input.Description)) {
	<h3>Description</h3>

	<p style="white-space: pre-line;">@Model.Input.Description</p>
}

<h3>Views & rating</h3>

@{
	Malsys.Media.ColorF ratingColor;
	var rating = (float)Model.Input.RatingSum / (float)Model.Input.RatingCount;
	float half = 2.5f;
	if (float.IsNaN(rating)) {
		ratingColor = Malsys.Media.ColorF.Black;
	}
	else if (rating > half) {
		ratingColor = new Malsys.Media.ColorF(0.0, (rating - half) / half, 0.0);  // 2.5 -- 5
	}
	else {
		ratingColor = new Malsys.Media.ColorF((half - rating) / half, 0.0, 0.0);
	}
}

<p>Views: <span class="huge">@Model.Input.Views</span></p>

<p>Rating: <span class="huge" style="color: #@ratingColor.ToRgbHexString();">@rating</span></p>
<div class="votes">
@if (User.Identity.IsAuthenticated) {
	<span class="vote">worst</span>
	for (int i = 0; i <= 5; i++) {
		var text = i.ToString() + CharHelper.ShadowedWhiteStar;
		<span class="vote">
		@if (Model.UserVote == null || Model.UserVote != i) {
			@Html.ActionLink(text, MVC.Gallery.Vote(Model.Input.UrlId, i))
  }
  else {
			@text
  }
		</span>
	}
	<span class="vote">best</span>
}
else {
	<p>Only registered users can vote.</p>
}
</div>


@if (Model.Input.Tags.Count > 0) {
	<h3>Tags</h3>
	foreach (var tag in Model.Input.Tags) {
		@Html.Tag(tag.Name)
	}
}


<h3>Source</h3>

<pre class="malsys box">
@Model.Input.SourceCode
@if (!string.IsNullOrWhiteSpace(Model.Input.ThumbnailSourceExtension)) {
<text>
// thumbnail extension</text>
@Model.Input.ThumbnailSourceExtension
}
</pre>

